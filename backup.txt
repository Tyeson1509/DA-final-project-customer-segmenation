import streamlit as st
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import plotly.express as px
import seaborn as sns
import pickle

# Using menu
st.title("Customer Segmentation Project")
st.write("âš ï¸ ***This is a demo app. All data shown is for illustrative purposes only.***")
st.markdown(
    """
    <hr style="border: 2px solid #004c99; margin-top: 10px; margin-bottom: 25px;">
    """,
    unsafe_allow_html=True
)
menu = ["How To Use","About this Project", "Segmentation Searching", "Input New Customers"]
choice = st.sidebar.selectbox('ğŸ“Œ Menu', menu)
st.sidebar.markdown("---")  # ÄÆ°á»ng káº» phÃ¢n cÃ¡ch

st.sidebar.markdown("""**ğŸ€ Sáº£n pháº©m Ä‘Æ°á»£c thá»±c hiá»‡n bá»Ÿi nhÃ³m:**\\
                             1.  Máº¡ch Cáº£nh ToÃ n\\
                             2.  HoÃ ng Thá»‹ Diá»‡p
                        """)
st.sidebar.markdown("""**ğŸ“ Giáº£ng viÃªn hÆ°á»›ng dáº«n:**\\
                             1.  CÃ´ Khuáº¥t ThÃ¹y PhÆ°Æ¡ng
                            """)

# Äá»c dá»¯ liá»‡u máº«u
# Load data máº«u vÃ o session state náº¿u chÆ°a cÃ³
if 'sample_data' not in st.session_state:
    st.session_state.sample_data = pd.read_csv("cust_seg_sample.csv")
sample_data = st.session_state.sample_data

# cluster_summary = pd.read_csv("cluster_summary.csv")

if choice == 'How To Use':
    st.subheader("How To Use This Website")
    st.write("##### **ğŸ‰ ChÃ o má»«ng báº¡n ghÃ© thÄƒm, vui lÃ²ng Ä‘á»c hÆ°á»›ng dáº«n bÃªn dÆ°á»›i Ä‘á»ƒ biáº¿t cÃ¡ch sá»­ dá»¥ng trang web nÃ y.**")
    st.write("""
    
    ###### â“ ChÃºng mÃ¬nh cÃ³ gÃ¬?
    - **How To Use**: HÆ°á»›ng dáº«n sá»­ dá»¥ng thanh Ä‘iá»u hÆ°á»›ng.
    - **About this Project**: Giá»›i thiá»‡u tá»•ng quan vá» dá»± Ã¡n.
    - **Segmentation Searching**: CÃ´ng cá»¥ tÃ¬m kiáº¿m thÃ´ng tin phÃ¢n khÃºc khÃ¡ch hÃ ng dá»±a trÃªn mÃ£ KH Ä‘Æ°á»£c cung cáº¥p.
    - **Input New Customers**: Äáº©y dá»¯ liá»‡u khÃ¡ch hÃ ng má»›i vÃ o há»‡ thá»‘ng.
    
    ###### ğŸ“ Má»™t sá»‘ thuáº­t ngá»¯ liÃªn quan Ä‘áº¿n Customer Segmentation:
    - **Recency (R)**: Äo lÆ°á»ng sá»‘ ngÃ y ká»ƒ tá»« láº§n mua hÃ ng cuá»‘i cÃ¹ng (láº§n truy cáº­p gáº§n Ä‘Ã¢y nháº¥t) Ä‘áº¿n ngÃ y giáº£ Ä‘á»‹nh chung Ä‘á»ƒ tÃ­nh toÃ¡n (vÃ­ dá»¥: ngÃ y hiá»‡n táº¡i, hoáº·c ngÃ y max trong danh sÃ¡ch giao dá»‹ch).
    - **Frequency (F)**: Äo lÆ°á»ng sá»‘ lÆ°á»£ng giao dá»‹ch (tá»•ng sá»‘ láº§n mua hÃ ng) Ä‘Æ°á»£c thá»±c hiá»‡n trong thá»i gian nghiÃªn cá»©u.
    - **Monetary Value (M)**: Äo lÆ°á»ng sá»‘ tiá»n mÃ  má»—i khÃ¡ch hÃ ng Ä‘Ã£ chi tiÃªu trong thá»i gian nghiÃªn cá»©u.
        
    ###### ğŸ“¢ So, let's get started!
    """)

elif choice == 'About this Project':    
    st.subheader("1. Business Understanding")
    st.write("""
    ###### Cá»­a hÃ ng X kinh doanh theo mÃ´ hÃ¬nh cá»­a hÃ ng tiá»‡n lá»£i vá»›i quy mÃ´ vá»«a vÃ  nhá» vÃ  hÆ°á»›ng tá»›i Ä‘á»‘i tÆ°á»£ng khÃ¡ch hÃ ng mua láº» lÃ  chá»§ yáº¿u. CÃ¡c sáº£n pháº©m Ä‘áº·c trÆ°ng táº¡i cá»­a hÃ ng bao gá»“m nhá»¯ng sáº£n pháº©m thiáº¿t yáº¿u nhÆ° thá»±c pháº©m (rau, cá»§, quáº£, thá»‹t, cÃ¡, trá»©ng, sá»¯a,...), nÆ°á»›c giáº£i khÃ¡t, Ä‘á»“ gia dá»¥ng, vá»‡ sinh nhÃ  cá»­a, chÄƒm sÃ³c cÃ¡ nhÃ¢n, chÄƒm sÃ³c thÃº cÆ°ng, sáº£n pháº©m theo mÃ¹a... 

    ###### ThÃ´ng qua dá»± Ã¡n nÃ y, cá»­a hÃ ng mong muá»‘n:
    ğŸ” Giá»›i thiá»‡u sáº£n pháº©m Ä‘áº¿n Ä‘Ãºng Ä‘á»‘i tÆ°á»£ng khÃ¡ch hÃ ng;\\
    ğŸ” Äá»‹nh hÆ°á»›ng Ä‘Ãºng chiáº¿n lÆ°á»£c chÄƒm sÃ³c khÃ¡ch hÃ ng cho tá»«ng phÃ¢n khÃºc khÃ¡ch hÃ ng;\\
    ğŸ” NÃ¢ng cao má»©c Ä‘á»™ hÃ i lÃ²ng cá»§a khÃ¡ch hÃ ng;\\
    ğŸ” BÃ¡n Ä‘Æ°á»£c nhiá»u hÃ ng hÃ³a hÆ¡n vÃ  thÃºc Ä‘áº©y tÄƒng doanh thu.

    ###### CÃ³ thá»ƒ tháº¥y, viá»‡c sá»­ dá»¥ng RFM Ä‘á»ƒ phÃ¢n khÃºc khÃ¡ch hÃ ng lÃ  má»™t phÆ°Æ¡ng Ã¡n khÃ¡ phÃ¹ há»£p vÃ  Ä‘Ã¡p á»©ng mong muá»‘n cá»§a doanh nghiá»‡p nháº±m giáº£i quyáº¿t váº¥n Ä‘á» nÃ y.
    """)    
    
    # Giá»›i thiá»‡u vá» Customer Segmentation
    st.subheader("2. Project Objective")
    # HÃ¬nh áº£nh minh há»a
    st.image("Customer-Segmentation.jpg", caption="Customer Segmentation", use_container_width=True)
    st.write("""
    ###### Customer segmentation lÃ  má»™t trong nhá»¯ng nhiá»‡m vá»¥ ná»n táº£ng cá»§a trong quáº£n lÃ½ khÃ¡ch hÃ ng vÃ  xÃ¢y dá»±ng chiáº¿n lÆ°á»£c tiáº¿p thá»‹. Báº±ng viá»‡c tiáº¿n hÃ nh nhÃ³m cÃ¡c khÃ¡ch hÃ ng láº¡i vá»›i nhau dá»±a trÃªn cÃ¡c Ä‘áº·c Ä‘iá»ƒm chung, Customer Segmentation há»— trá»£ doanh nghiá»‡p nháº¯m tá»›i má»¥c tiÃªu khÃ¡ch hÃ ng thÃ´ng qua viá»‡c cÃ¡ nhÃ¢n hÃ³a, tung ra cÃ¡c chiáº¿n dá»‹ch quáº£ng cÃ¡o, truyá»n thÃ´ng phÃ¹ há»£p, thiáº¿t káº¿ Æ°u Ä‘Ã£i hoáº·c khuyáº¿n mÃ£i má»›i, vÃ  cÅ©ng Ä‘á»ƒ bÃ¡n hÃ ng.

    ###### Lá»£i Ã­ch cá»§a viá»‡c phÃ¢n khÃºc khÃ¡ch hÃ ng:
    âœ”ï¸ **Tiáº¿p thá»‹ hiá»‡u quáº£**: Táº¡o chiáº¿n dá»‹ch phÃ¹ há»£p tá»«ng nhÃ³m khÃ¡ch hÃ ng.\\
    âœ”ï¸ **Giá»¯ chÃ¢n khÃ¡ch hÃ ng**: ChÃ­nh sÃ¡ch Ä‘áº·c biá»‡t Ä‘á»ƒ duy trÃ¬ khÃ¡ch hÃ ng trung thÃ nh.\\
    âœ”ï¸ **Cáº£i thiá»‡n dá»‹ch vá»¥**: Hiá»ƒu nhu cáº§u Ä‘á»ƒ tá»‘i Æ°u hÃ³a tráº£i nghiá»‡m khÃ¡ch hÃ ng.\\
    âœ”ï¸ **Má»Ÿ rá»™ng thá»‹ trÆ°á»ng**: PhÃ¡t triá»ƒn sáº£n pháº©m/dá»‹ch vá»¥ theo sá»Ÿ thÃ­ch khÃ¡ch hÃ ng.\\
    âœ”ï¸ **Tá»‘i Æ°u giÃ¡**: Äá»‹nh giÃ¡ há»£p lÃ½ theo tÃ¬nh tráº¡ng tÃ i chÃ­nh khÃ¡ch hÃ ng.\\
    âœ”ï¸ **TÄƒng doanh thu**: Táº­p trung vÃ o phÃ¢n khÃºc cÃ³ lá»£i nhuáº­n cao, giáº£m chi phÃ­ bÃ¡n hÃ ng.

    ###### Dá»± Ã¡n nÃ y sá»­ dá»¥ng model Kmeans Ä‘á»ƒ tiáº¿n hÃ nh phÃ¢n khÃºc khÃ¡ch hÃ ng, tá»« Ä‘Ã³ Ä‘á» xuáº¥t nhá»¯ng chiáº¿n lÆ°á»£c bÃ¡n hÃ ng phÃ¹ há»£p.
    """)

elif choice == 'Segmentation Searching':
    # Chá»n nháº­p mÃ£ khÃ¡ch hÃ ng hoáº·c nháº­p thÃ´ng tin khÃ¡ch hÃ ng vÃ o dataframe
    st.subheader("1. Customer Segment Searching")
    type = st.radio("Chá»n cÃ¡ch nháº­p thÃ´ng tin khÃ¡ch hÃ ng", options=["TÃ¬m kiá»ƒm theo mÃ£ khÃ¡ch hÃ ng", "TÃ¬m kiáº¿m theo danh sÃ¡ch"])
    
    # Dá»¯ liá»‡u vá» chiáº¿n lÆ°á»£c marketing
    mkt_strategy = pd.read_csv("mkt_strategies.csv", encoding='latin1') 
       
    if type == "TÃ¬m kiá»ƒm theo mÃ£ khÃ¡ch hÃ ng":
        # Náº¿u ngÆ°á»i dÃ¹ng chá»n nháº­p mÃ£ khÃ¡ch hÃ ng
        st.write("#### TÃ¬m kiá»ƒm theo mÃ£ khÃ¡ch hÃ ng")
        # Táº¡o Ä‘iá»u khiá»ƒn Ä‘á»ƒ ngÆ°á»i dÃ¹ng nháº­p mÃ£ khÃ¡ch hÃ ng
        customer_id = st.text_input("***Vui lÃ²ng nháº­p mÃ£ khÃ¡ch hÃ ng***", placeholder="VÃ­ dá»¥: KH1000")
        # Náº¿u ngÆ°á»i dÃ¹ng nháº­p mÃ£ khÃ¡ch hÃ ng, thá»±c hiá»‡n cÃ¡c xá»­ lÃ½ tiáº¿p theo
        # Äá» xuáº¥t khÃ¡ch hÃ ng thuá»™c cá»¥m
        # In káº¿t quáº£ ra mÃ n hÃ¬nh
        if customer_id in sample_data['Member_number'].values:
            customer_data = sample_data[sample_data['Member_number']==customer_id]
            customer_data = pd.merge(customer_data, mkt_strategy, on='Cluster', how='left')
            st.write(f"**MÃ£ khÃ¡ch hÃ ng:** {customer_id}")
            st.write("**ThÃ´ng tin phÃ¢n cá»¥m:**")
            st.dataframe(customer_data)
        elif customer_id not in sample_data['Member_number'].values and customer_id!="":
            st.warning("ChÆ°a cÃ³ thÃ´ng tin khÃ¡ch hÃ ng trÃªn há»‡ thá»‘ng, vui lÃ²ng nháº­p láº¡i")
            st.write("VÃ­ dá»¥ mÃ£ khÃ¡ch hÃ ng há»£p lá»‡: KH1000, KH1001, KH1002,...")
    
    elif type == "TÃ¬m kiáº¿m theo danh sÃ¡ch":
        st.write("#### TÃ¬m kiá»ƒm theo danh sÃ¡ch")
        # Táº¡o thanh upload file
        uploaded_file = st.file_uploader("ğŸ“‚ Chá»n file (cÃ³ chá»©a mÃ£ khÃ¡ch hÃ ng)", type=["csv", "xlsx"])

        # Náº¿u cÃ³ file Ä‘Æ°á»£c táº£i lÃªn
        if uploaded_file is not None:
            # Äá»c dá»¯ liá»‡u vÃ o DataFrame
            if uploaded_file.name.endswith('.csv'):
                customer_df = pd.read_csv(uploaded_file)
            else:
                customer_df = pd.read_excel(uploaded_file)
            # ThÃ´ng bÃ¡o thÃ nh cÃ´ng
            st.success("Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c táº£i lÃªn")
            # 2. NÃºt báº¥m Ä‘á»ƒ báº¯t Ä‘áº§u phÃ¢n cá»¥m
        
        if st.button("ğŸš€ Láº¥y dá»¯ liá»‡u cá»¥m"):
            # Kiá»ƒm tra customer_id cÃ³ tá»“n táº¡i trong dá»¯ liá»‡u mÃ´ hÃ¬nh khÃ´ng
            try:
                customer_df['Member_number'] = customer_df['Member_number'].astype(str)
            except Exception as e:
                st.warning("âŒ Dá»¯ liá»‡u 'Member_number' khÃ´ng há»£p lá»‡")
        
            merged_df = pd.merge(customer_df, sample_data, on="Member_number", how="left")

            # Lá»c cÃ¡c khÃ¡ch hÃ ng khÃ´ng cÃ³ Ä‘áº·c trÆ°ng phÃ¹ há»£p
            missing_customers = merged_df[merged_df.isnull().any(axis=1)]['Member_number'].tolist()

            # Tiáº¿n hÃ nh gÃ¡n cá»¥m náº¿u Ä‘á»§ dá»¯ liá»‡u
            valid_data = merged_df.dropna()

            if not valid_data.empty:
                valid_data = pd.merge(valid_data, mkt_strategy, on='Cluster', how='left')
                # Dá»± Ä‘oÃ¡n cá»¥m
                st.success("ğŸ‰ ÄÃ£ hoÃ n táº¥t, báº¡n cÃ³ thá»ƒ táº£i file vá»!")
                st.dataframe(valid_data[['Member_number', 'Cluster', 'Objective', 'Suggestion']])

            if missing_customers:
                st.warning(f"âš ï¸ CÃ¡c mÃ£ KH sau chÆ°a cÃ³ trÃªn há»‡ thá»‘ng: {', '.join(missing_customers)}")
    
    # Äá»c data
    st.subheader("2. Customer Segmentation Summary")
    # Tá»•ng sá»‘ KH hiá»‡n táº¡i
    total_member = sample_data['Member_number'].nunique()
    # Dá»¯ liá»‡u trung tÃ¢m cá»¥m
    cluster_summary = sample_data.groupby("Cluster").agg(
    Mean_Recency=("Recency", "mean"),
    Mean_Frequency=("Frequency", "mean"),
    Mean_Monetary=("Monetary", "mean"),
    Count=("Member_number", "count")
    )
    cluster_summary["Percentage"] = (cluster_summary["Count"] / sample_data.shape[0]) * 100
    cluster_summary = cluster_summary.reset_index()
    
    st.write(f"Tá»•ng sá»‘ khÃ¡ch hÃ ng trÃªn há»‡ thá»‘ng: {total_member}")
    st.write("ThÃ´ng tin cá»¥m:")
    st.write(cluster_summary)
    fig = px.pie(cluster_summary, names='Cluster', values='Count',
             title='Tá»· lá»‡ khÃ¡ch hÃ ng theo cá»¥m')
    st.plotly_chart(fig)
    
    st.subheader("3. Marketing Strategies")
    st.dataframe(mkt_strategy)
    
elif choice == 'Input New Customers':
    st.write("##### Báº¡n muá»‘n thÃªm thÃ´ng tin khÃ¡ch hÃ ng má»›i vÃ o há»‡ thá»‘ng, vui lÃ²ng thá»±c hiá»‡n cÃ¡c bÆ°á»›c sau")
    # Chá»n input tá»«ng mÃ£ khÃ¡ch hÃ ng hoáº·c input báº±ng file
    type = st.radio("Chá»n cÃ¡ch input thÃ´ng tin khÃ¡ch hÃ ng", options=["Nháº­p 1 khÃ¡ch hÃ ng má»›i", "Nháº­p 5 khÃ¡ch hÃ ng má»›i", "Upload file khÃ¡ch hÃ ng má»›i"])
    
    # Láº¥y mÃ£ sá»‘ KH lá»›n nháº¥t hiá»‡n táº¡i
    num_part = sample_data['Member_number'].str.extract(r'KH(\d+)', expand=False).astype(int)
    max_id = num_part.max()
    
    # Load mÃ´ hÃ¬nh phÃ¢n cá»¥m KMeans tá»« file .pkl
    with open('kmeans_model.pkl', 'rb') as file:
        kmeans = pickle.load(file)

    #st.write("Sá»‘ Ä‘áº·c trÆ°ng mÃ´ hÃ¬nh yÃªu cáº§u:", kmeans.n_features_in_)


    # GÃ¡n nhÃ£n tÃªn cá»¥m
    label_map = {
        0: "Potential Loyalists",
        1: "Churned Customers",
        2: "Loyal Customers",
        3: "One-time Shoppers",
        4: "Big Spenders"
    }
    
    if type == "Nháº­p 1 khÃ¡ch hÃ ng má»›i":
        if type == "Nháº­p 1 khÃ¡ch hÃ ng má»›i":
            new_recency = st.number_input("***Nháº­p chá»‰ sá»‘ Recency (ngÃ y)***", min_value=1, max_value=730, step=1)
            new_frequency = st.number_input("***Nháº­p chá»‰ sá»‘ Frequency (sá»‘ láº§n mua)***", min_value=1, max_value=500, step=1)
            new_monetary = st.number_input("***Nháº­p chá»‰ sá»‘ Monetary (Ä‘Ã´)***", min_value=1, max_value=5000, step=1)

            if st.button("ğŸš€ Xem trÆ°á»›c vÃ  phÃ¢n cá»¥m"):
                new_id = f"KH{max_id + 1}"
                new_customer = pd.DataFrame([{"Member_number":new_id, "Recency": new_recency, "Frequency": new_frequency, "Monetary": new_monetary}])

                # PhÃ¢n cá»¥m
                X1 = new_customer.drop(columns=['Member_number'])
                clusters = kmeans.predict(X1)
                new_customer['Cluster'] = clusters
                new_customer['Cluster'] = new_customer['Cluster'].map(label_map)

                st.write("##### Xem trÆ°á»›c")
                st.dataframe(new_customer)

                st.session_state.new_customer = new_customer

            # NÃºt lÆ°u
            if 'new_customer' in st.session_state:
                if st.button("ğŸ’¾ LÆ°u khÃ¡ch hÃ ng"):
                    st.session_state.sample_data = pd.concat([st.session_state.sample_data, st.session_state.new_customer], ignore_index=True)
                    st.session_state.sample_data.to_csv('cust_seg_sample.csv', index=False)
                    st.success("âœ… ÄÃ£ thÃªm khÃ¡ch hÃ ng má»›i!")
                    st.dataframe(st.session_state.sample_data.tail())
    
    elif type == "Nháº­p 5 khÃ¡ch hÃ ng má»›i":
        # Náº¿u ngÆ°á»i dÃ¹ng chá»n nháº­p thÃ´ng tin khÃ¡ch hÃ ng vÃ o dataframe cÃ³ 3 cá»™t lÃ  Recency, Frequency, Monetary
        st.write("##### ThÃ´ng tin khÃ¡ch hÃ ng")
        # Táº¡o Ä‘iá»u khiá»ƒn table Ä‘á»ƒ ngÆ°á»i dÃ¹ng nháº­p thÃ´ng tin khÃ¡ch hÃ ng trá»±c tiáº¿p trÃªn table
        st.write("Nháº­p thÃ´ng tin khÃ¡ch hÃ ng")
        # Táº¡o dataframe Ä‘á»ƒ ngÆ°á»i dÃ¹ng nháº­p thÃ´ng tin khÃ¡ch hÃ ng
        df_customer = pd.DataFrame(columns=["Member_number", "Recency", "Frequency", "Monetary"])
        for i in range(5):
            st.write(f"KhÃ¡ch hÃ ng {i+1}")
            # Táº¡o mÃ£ KH má»›i
            new_id = f"KH{max_id + i + 1}"
            # Táº¡o cÃ¡c slider Ä‘á»ƒ nháº­p giÃ¡ trá»‹ cho cá»™t Recency, Frequency, Monetary
            recency = st.slider("Recency", 1, 730, 100, key=f"recency_{i}")
            frequency = st.slider("Frequency", 1, 40, 5, key=f"frequency_{i}")
            monetary = st.slider("Monetary", 1, 380, 100, key=f"monetary_{i}")
            # CÅ©ng cÃ³ thá»ƒ thay báº±ng cÃ¡c Ä‘iá»u khiá»ƒn khÃ¡c nhÆ° number_input...
            # ThÃªm thÃ´ng tin khÃ¡ch hÃ ng vá»«a nháº­p vÃ o dataframe
            new_row = pd.DataFrame([{"Member_number":new_id, "Recency": recency, "Frequency": frequency, "Monetary": monetary}])
            df_customer = pd.concat([df_customer, new_row], ignore_index=True)            
        
        # Thá»±c hiá»‡n phÃ¢n cá»¥m khÃ¡ch hÃ ng dá»±a trÃªn giÃ¡ trá»‹ cá»§a 3 cá»™t nÃ y
        X = df_customer.drop(columns=['Member_number']) # Láº¥y dá»¯ liá»‡u cáº§n Ä‘á»ƒ dá»± Ä‘oÃ¡n
        clusters = kmeans.predict(X) # Tiáº¿n hÃ nh dá»± Ä‘oÃ¡n
        df_customer['Cluster'] = clusters
        df_customer['Cluster'] = df_customer['Cluster'].map(label_map)
        # In káº¿t quáº£ ra mÃ n hÃ¬nh
        st.write("##### Xem trÆ°á»›c")
        st.write(df_customer)
        # LÆ°u thÃ´ng tin
        st.write("##### LÆ°u thÃ´ng tin vÃ o há»‡ thá»‘ng")
        if st.button("ğŸ’¾ LÆ°u khÃ¡ch hÃ ng"):
            sample_data = pd.concat([sample_data,df_customer], ignore_index=True)
            sample_data.to_csv('cust_seg_sample.csv', index=False)
            st.success("âœ… ÄÃ£ thÃªm khÃ¡ch hÃ ng má»›i!")
            st.dataframe(sample_data.tail())
            
    else:
        # Táº¡o thanh upload file
        uploaded_file = st.file_uploader("ğŸ“‚ Chá»n file (cÃ³ chá»©a thÃ´ng tin RFM)", type=["csv", "xlsx"])


        if uploaded_file is not None:
            if uploaded_file.name.endswith('.csv'):
                new_customer_df = pd.read_csv(uploaded_file)
            else:
                new_customer_df = pd.read_excel(uploaded_file)
            st.success("Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c táº£i lÃªn")

            if st.button("ğŸš€ Láº¥y dá»¯ liá»‡u cá»¥m"):
                try:
                    new_customer_df['Recency'] = new_customer_df['Recency'].astype(float)
                    new_customer_df['Frequency'] = new_customer_df['Frequency'].astype(float)
                    new_customer_df['Monetary'] = new_customer_df['Monetary'].astype(float)

                    X = new_customer_df[['Recency','Frequency','Monetary']]
                    clusters = kmeans.predict(X)
                    new_customer_df['Cluster'] = clusters
                    new_customer_df['Cluster'] = new_customer_df['Cluster'].map(label_map)

                    max_id = st.session_state.sample_data['Member_number'].str.extract(r'KH(\d+)', expand=False).astype(int).max()
                    new_customer_df['Member_number'] = ['KH' + str(i) for i in range(max_id + 1, max_id + 1 + len(new_customer_df))]
                    
                    st.session_state.new_customer_df = new_customer_df
                    st.write("##### Xem trÆ°á»›c")
                    st.dataframe(new_customer_df)

                except Exception as e:
                    st.warning(f"âŒ Xá»­ lÃ½ lá»—i: {e}")

        # NÃºt lÆ°u
        if 'new_customer_df' in st.session_state:
            if st.button("ğŸ’¾ LÆ°u khÃ¡ch hÃ ng"):
                st.session_state.sample_data = pd.concat([st.session_state.sample_data, st.session_state.new_customer_df], ignore_index=True)
                st.session_state.sample_data.to_csv('cust_seg_sample.csv', index=False)
                st.success("âœ… ÄÃ£ thÃªm khÃ¡ch hÃ ng má»›i!")
                st.dataframe(st.session_state.sample_data.tail())